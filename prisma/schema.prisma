// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum ResourceType {
  ARCHIUM
  FAMILY_SEARCH
  WIKIPEDIA
  BABYN_YAR
  WEBSITE
}

model Archive {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String    @db.VarChar(10)
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @updatedAt @db.Timestamp(6)
  title        String?   @db.VarChar(255)
  info         String?   @db.VarChar(255)
  url          String?   @db.VarChar(255)
  address      String?   @db.VarChar(255)
  phone_number String?   @db.VarChar(20)
  email        String?   @db.VarChar(255)
  logo_url     String?   @db.VarChar(255)
  funds        Fund[]
  matches      Match[]
  fetches      Fetch[]

  @@index([code])
  @@map("archives")
}

model Fund {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String        @db.VarChar(10)
  created_at   DateTime      @default(now()) @db.Timestamp(6)
  updated_at   DateTime?     @updatedAt @db.Timestamp(6)
  title        String?       @db.VarChar(255)
  info         String?       @db.VarChar(255)
  archive_id   String        @db.Uuid
  archive      Archive       @relation(fields: [archive_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  descriptions Description[]
  matches      Match[]
  fetches      Fetch[]

  @@unique([code, archive_id])
  @@index([code])
  @@map("funds")
}

model Description {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String    @db.VarChar(10)
  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt @db.Timestamp(6)
  title      String?   @db.VarChar(255)
  info       String?   @db.VarChar(255)
  fund_id    String    @db.Uuid
  fund       Fund      @relation(fields: [fund_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cases      Case[]
  matches    Match[]
  fetches    Fetch[]

  @@unique([code, fund_id])
  @@index([code])
  @@map("descriptions")
}

model Case {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String      @db.VarChar(20)
  created_at     DateTime    @default(now()) @db.Timestamp(6)
  updated_at     DateTime?   @updatedAt @db.Timestamp(6)
  title          String?     @db.VarChar(255)
  info           String?     @db.VarChar(255)
  description_id String      @db.Uuid
  description    Description @relation(fields: [description_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  matches        Match[]
  fetches        Fetch[]

  @@unique([code, description_id])
  @@index([code])
  @@index([description_id])
  @@map("cases")
}

model Resource {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at DateTime      @default(now()) @db.Timestamp(6)
  updated_at DateTime?     @updatedAt @db.Timestamp(6)
  code       String        @db.VarChar(50)
  title      String?       @db.VarChar(255)
  info       String?       @db.VarChar(255)
  url        String?       @db.VarChar(255)
  logo_url   String?       @db.VarChar(255)
  type       ResourceType?
  matches    Match[]
  fetches    Fetch[]

  @@map("resources")
}

model Match {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at     DateTime      @default(now()) @db.Timestamp(6)
  updated_at     DateTime?     @updatedAt @db.Timestamp(6)
  resource_id    String        @db.Uuid
  resource       Resource      @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  url            String?       @db.VarChar(255)
  api_url        String        @db.VarChar(255)
  api_params     String?       @db.VarChar(255)
  archive_id     String?       @db.Uuid
  archive        Archive?      @relation(fields: [archive_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fund_id        String?       @db.Uuid
  fund           Fund?         @relation(fields: [fund_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  description_id String?       @db.Uuid
  description    Description?  @relation(fields: [description_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  case_id        String?       @db.Uuid
  case           Case?         @relation(fields: [case_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children_count Int?
  full_code      String?
  results        MatchResult[]

  @@unique([resource_id, archive_id, fund_id, description_id, case_id, api_params])
  @@index([full_code])
  @@index([full_code(ops: raw("gin_trgm_ops"))], type: Gin, name: "full_code_gin_trgm_ops_idx")
  @@map("matches")
}

model MatchResult {
  created_at DateTime @default(now()) @db.Timestamp(6)
  match_id   String   @db.Uuid
  match      Match    @relation(fields: [match_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  count      Int
  error      String?

  @@id([match_id, created_at])
  @@map("match_results")
}

model Fetch {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at     DateTime      @default(now()) @db.Timestamp(6)
  updated_at     DateTime?     @updatedAt @db.Timestamp(6)
  resource_id    String        @db.Uuid
  resource       Resource      @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  api_url        String        @db.VarChar(255)
  api_params     String?       @db.VarChar(255)
  archive_id     String?       @db.Uuid
  archive        Archive?      @relation(fields: [archive_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fund_id        String?       @db.Uuid
  fund           Fund?         @relation(fields: [fund_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  description_id String?       @db.Uuid
  description    Description?  @relation(fields: [description_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  case_id        String?       @db.Uuid
  case           Case?         @relation(fields: [case_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children_count Int?
  results        FetchResult[]

  @@unique([resource_id, archive_id, fund_id, description_id, case_id, api_params])
  @@map("fetches")
}

model FetchResult {
  created_at DateTime @default(now()) @db.Timestamp(6)
  fetch_id   String   @db.Uuid
  fetch      Fetch?   @relation(fields: [fetch_id], references: [id])
  count      Int
  error      String?

  @@id([fetch_id, created_at])
  @@map("fetch_results")
}
